<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Math Helper Infinite Launcher</title>
<style>
  body { margin:0; font-family: Arial,sans-serif; background:#0e0e0e; color:white; display:flex; flex-direction:column; min-height:100vh; }
  header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#121212; border-bottom:1px solid #333; }
  header h1 { font-size:24px; margin:0; cursor:pointer; }
  main { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; }
  .hidden { display:none; }
  input, button { padding:10px; border-radius:5px; border:none; font-size:16px; }
  button { cursor:pointer; background:#444; color:white; }
  button:hover { background:#666; }
</style>
</head>
<body>

<header><h1>Math Helper Infinite</h1></header>

<main>
  <!-- Container where GitHub launcher will be injected -->
  <div id="launcherContainer">
    <p>Loading launcher...</p>
  </div>
</main>

<footer>&copy; 2026 Made by CollinAwesome5</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

// --------------------
// Firebase Configuration
// --------------------
const firebaseConfig = {
  apiKey: "AIzaSyC9A9TbMSib5-_dW4A9w0jNySfN-0TkR48",
  authDomain: "mhi-v4.firebaseapp.com",
  databaseURL: "https://mhi-v4-default-rtdb.firebaseio.com",
  projectId: "mhi-v4",
  storageBucket: "mhi-v4.firebasestorage.app",
  messagingSenderId: "592695127206",
  appId: "1:592695127206:web:c423586566d72084ff9867",
  measurementId: "G-YY300GTP5H"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --------------------
// Variables
// --------------------
const launcherContainer = document.getElementById("launcherContainer");
const BUILT_IN_KEY = "te5T1nG14S";
let userCode = localStorage.getItem("userCode");
let fullName = localStorage.getItem("fullName");

// --------------------
// Load launcher HTML from GitHub
// --------------------
async function loadLauncherHTML() {
  try {
    const res = await fetch("https://raw.githubusercontent.com/CollinAwesome5/even-more-games/main/games5/launcher.html");
    if (!res.ok) throw new Error("Failed to fetch launcher.html");
    const html = await res.text();
    launcherContainer.innerHTML = html;
    initializeLauncher(); // After injection, initialize
  } catch (err) {
    launcherContainer.innerHTML = `<p style="color:red;">Error loading launcher: ${err.message}</p>`;
  }
}

// --------------------
// Activation Key Check
// --------------------
async function checkActivationKey() {
  try {
    const res = await fetch("https://raw.githubusercontent.com/CollinAwesome5/even-more-games/main/games5/activation-keys.txt");
    const keysText = await res.text();
    const validKeys = keysText.split("\n").map(line => line.trim());
    if (!validKeys.includes(BUILT_IN_KEY)) {
      launcherContainer.innerHTML = `<p style="color:red;">Launcher cannot start: Activation key mismatch.</p>`;
      throw new Error("Activation key invalid.");
    }
    // Key is valid â†’ proceed to signup
  } catch (err) {
    launcherContainer.innerHTML = `<p style="color:red;">Failed to verify activation key: ${err.message}</p>`;
    throw err;
  }
}

// --------------------
// User Signup Flow
// --------------------
async function signupFlow() {
  if (!userCode) {
    userCode = Math.random().toString(36).substring(2,12);
    localStorage.setItem("userCode", userCode);
  }
  if (!fullName) {
    fullName = prompt("Enter your full name:");
    localStorage.setItem("fullName", fullName);
  }

  // Save user in Firestore if not exists
  const userRef = doc(db,"sessions",userCode);
  const docSnap = await getDoc(userRef);
  if (!docSnap.exists()) {
    await setDoc(userRef, {
      fullName,
      userCode,
      favorites: [],
      savedGames: {},
      settings: { cookiesPerGame:3, darkMode:true },
      gamesPlayed: 0,
      status: "active",
      blocked: { games:false, proxy:false }
    });
  }
}

// --------------------
// Initialize Launcher
// --------------------
async function initializeLauncher() {
  await checkActivationKey();
  await signupFlow();

  // Now your injected launcher.html scripts can run normally
  console.log("Launcher initialized for user:", fullName, userCode);
}

// --------------------
// Start process
// --------------------
loadLauncherHTML();

</script>

</body>
</html>
<script type="module">
// --------------------
// Variables
// --------------------
const mainLauncher = document.createElement("div");
mainLauncher.id = "mainLauncher";
mainLauncher.classList.add("hidden");
launcherContainer.appendChild(mainLauncher);

let allGames = [];    // Placeholder array, will fetch real games later
let currentPage = "games"; // default page

// --------------------
// Page Navigation
// --------------------
const nav = document.createElement("nav");
nav.style.display = "flex";
nav.style.justifyContent = "center";
nav.style.gap = "20px";
nav.style.marginBottom = "20px";

["games","favorites","about","proxy"].forEach(page=>{
  const btn = document.createElement("button");
  btn.className = "pageBtn";
  btn.dataset.page = page;
  btn.textContent = page.charAt(0).toUpperCase()+page.slice(1);
  btn.addEventListener("click", ()=>{
    currentPage = btn.dataset.page;
    updatePagesUI();
    renderPage();
  });
  nav.appendChild(btn);
});
mainLauncher.appendChild(nav);

// --------------------
// Search Bar
// --------------------
const searchInput = document.createElement("input");
searchInput.id = "searchInput";
searchInput.placeholder = "Search games...";
searchInput.style.marginBottom = "20px";
searchInput.style.padding = "8px";
searchInput.style.width = "80%";
searchInput.style.maxWidth = "400px";
mainLauncher.appendChild(searchInput);

// --------------------
// Games Container
// --------------------
const gamesContainer = document.createElement("div");
gamesContainer.id = "gamesContainer";
gamesContainer.style.display = "grid";
gamesContainer.style.gridTemplateColumns = "repeat(auto-fill,minmax(150px,1fr))";
gamesContainer.style.gap = "15px";
gamesContainer.style.width = "90%";
gamesContainer.style.maxWidth = "1000px";
gamesContainer.style.margin = "0 auto";
mainLauncher.appendChild(gamesContainer);

// --------------------
// Update Nav Buttons UI
// --------------------
function updatePagesUI(){
  document.querySelectorAll(".pageBtn").forEach(btn=>{
    if(btn.dataset.page === currentPage){
      btn.innerHTML = `<b>${btn.dataset.page.charAt(0).toUpperCase()+btn.dataset.page.slice(1)}</b>`;
    } else {
      btn.textContent = btn.dataset.page.charAt(0).toUpperCase()+btn.dataset.page.slice(1);
    }
  });
}

// --------------------
// Fetch Games (placeholder)
// --------------------
async function fetchGames(){
  // Later replace with actual repo fetch
  allGames = [
    {id:"game1",name:"Game One",repo:"games2",thumbnail:"https://via.placeholder.com/150"},
    {id:"game2",name:"Game Two",repo:"games3",thumbnail:"https://via.placeholder.com/150"},
    {id:"game3",name:"Game Three",repo:"games4",thumbnail:"https://via.placeholder.com/150"}
  ];
}

// --------------------
// Render About Page from about.txt
// --------------------
async function loadAboutPage(){
  try {
    const res = await fetch("https://raw.githubusercontent.com/CollinAwesome5/even-more-games/main/games5/about.txt");
    if(!res.ok) throw new Error("Failed to fetch about.txt");
    const text = await res.text();
    const lines = text.split("\n");
    let html = "";
    lines.forEach(line=>{
      if(line.startsWith("//")) return; // skip comments
      let processed = line
        .replace(/<center>/g,'<div style="text-align:center;">')
        .replace(/<\/center>/g,'</div>')
        .replace(/<bold>/g,'<b>').replace(/<\/bold>/g,'</b>')
        .replace(/<itallics>/g,'<i>').replace(/<\/itallics>/g,'</i>')
        .replace(/<small>/g,'<small>').replace(/<\/small>/g,'</small>')
        .replace(/<link-(.*?)>/g,'<a href="$1" target="_blank">here</a>')
        .replace(/<email>/g,'<a href="mailto:andercol046@alpinesd.org">here</a>');
      html += processed + "<br>";
    });
    gamesContainer.innerHTML = `<div style="width:80%; max-width:700px;">${html}</div>`;
  } catch(err){
    gamesContainer.innerHTML = `<p style="color:red;">Error loading about.txt: ${err.message}</p>`;
  }
}

// --------------------
// Render Proxy Page
// --------------------
function renderProxyPage(){
  gamesContainer.innerHTML = "";
  const proxyBtn = document.createElement("button");
  proxyBtn.textContent = "Launch Proxy";
  proxyBtn.style.padding = "20px";
  proxyBtn.style.fontSize = "18px";
  proxyBtn.addEventListener("click", ()=>{
    window.open("/prox.html","_blank"); // later replace with repo fetch
  });
  gamesContainer.appendChild(proxyBtn);
}

// --------------------
// Render Games Page
// --------------------
function renderGamesPage(){
  gamesContainer.innerHTML = "";
  allGames.forEach(game=>{
    const card = document.createElement("div");
    card.style.background="#222";
    card.style.padding="10px";
    card.style.borderRadius="8px";
    card.style.textAlign="center";

    const wrapper = document.createElement("div");
    wrapper.style.position="relative";

    const img = document.createElement("img");
    img.src = game.thumbnail;
    img.style.width="100%";
    img.style.height="120px";
    img.style.objectFit="cover";
    img.style.borderRadius="5px";
    wrapper.appendChild(img);

    const star = document.createElement("span");
    star.className = "favStar";
    star.dataset.gameid = game.id;
    star.textContent = favorites.includes(game.id)?"â˜…":"â˜†";
    star.style.position = "absolute";
    star.style.top = "5px";
    star.style.right = "5px";
    star.style.cursor = "pointer";
    star.style.color = "yellow";
    wrapper.appendChild(star);

    star.addEventListener("click", async ()=>{
      if(favorites.includes(game.id)){
        favorites = favorites.filter(f=>f!==game.id);
        star.textContent = "â˜†";
      } else {
        favorites.push(game.id);
        star.textContent = "â˜…";
      }
      // TODO: save favorites to Firebase
    });

    const nameP = document.createElement("p");
    nameP.textContent = game.name;

    const playBtn = document.createElement("button");
    playBtn.textContent = "Play";
    playBtn.onclick = ()=>launchGame(game.repo,game.id);

    card.appendChild(wrapper);
    card.appendChild(nameP);
    card.appendChild(playBtn);

    gamesContainer.appendChild(card);
  });
}

// --------------------
// Render page based on currentPage
// --------------------
function renderPage(){
  if(currentPage==="games") renderGamesPage();
  else if(currentPage==="favorites") renderGamesPage();
  else if(currentPage==="about") loadAboutPage();
  else if(currentPage==="proxy") renderProxyPage();

  // Hide search for about/proxy
  searchInput.style.display = (currentPage==="about"||currentPage==="proxy") ? "none" : "block";
}

// --------------------
// Launch Game Placeholder
// --------------------
window.launchGame = function(repo,gameId){
  const win = window.open("", "_blank");
  win.document.write(`<p>Loading ${gameId} from repo ${repo}...</p>`);
  // Saved game & pause/resume will be implemented later
}

// --------------------
// Initialize Launcher
// --------------------
async function initLauncherPart2(){
  await fetchGames();
  mainLauncher.classList.remove("hidden");
  updatePagesUI();
  renderPage();
}

initLauncherPart2();

</script>
<script type="module">
// --------------------
// User Data & State
// --------------------
let userName = localStorage.getItem("userName") || "";
let userBlocked = false; // Will track if user is blocked from playing
let openGameWindows = {}; // {gameId: windowReference}

// --------------------
// Enforce Name Signup
// --------------------
async function enforceNameSignup() {
  if(!userName || userName.length < 3){
    alert("You must enter a valid name to continue.");
    mainLauncher.classList.add("hidden");
    const nameInput = prompt("Enter your full name:");
    if(!nameInput || nameInput.length < 3){
      enforceNameSignup(); // loop until valid
      return;
    }
    userName = nameInput;
    localStorage.setItem("userName", userName);
    mainLauncher.classList.remove("hidden");
  }
}

// --------------------
// Pause/Resume Games
// --------------------
function pauseAllGames(){
  Object.entries(openGameWindows).forEach(([gameId,win])=>{
    if(!win.closed){
      win.document.body.innerHTML = "<p>Game paused. Please resume via launcher.</p>";
      win.isPaused = true;
    }
  });
}

function resumeAllGames(){
  Object.entries(openGameWindows).forEach(([gameId,win])=>{
    if(!win.closed && win.isPaused){
      win.document.body.innerHTML = `<p>Resuming ${gameId}...</p>`;
      win.isPaused = false;
    }
  });
}

// --------------------
// Launcher Close / Focus
// --------------------
window.addEventListener("beforeunload", (e)=>{
  // Pause all games if launcher closes
  pauseAllGames();
  // Let browser close normally if offline
  if(!navigator.onLine){
    return undefined;
  }
  // Block closing while online
  e.preventDefault();
  e.returnValue = "";
});

// If launcher regains focus, resume games
window.addEventListener("focus", ()=>{
  if(navigator.onLine){
    resumeAllGames();
  }
});

// --------------------
// Online/Offline Handling
// --------------------
window.addEventListener("offline", ()=>{
  // Allow users to continue playing while offline
  Object.entries(openGameWindows).forEach(([gameId,win])=>{
    if(!win.closed){
      win.isPaused = false;
    }
  });
});

window.addEventListener("online", ()=>{
  // If they reconnect, enforce block/pause rules
  if(userBlocked){
    pauseAllGames();
  }
});

// --------------------
// User Block Handling
// --------------------
async function checkUserBlocked() {
  // Fetch block status from Firebase
  // Placeholder: will implement actual Firebase call later
  // Example: userBlocked = await Firebase.getUserBlocked(userCode);
  if(userBlocked){
    alert("You are currently blocked from playing games.");
    pauseAllGames();
  }
}

// --------------------
// Launch Game Override
// --------------------
window.launchGame = function(repo, gameId){
  if(!userName || userName.length < 3){
    alert("Please enter your name before playing games.");
    enforceNameSignup();
    return;
  }
  if(userBlocked){
    alert("You are blocked from playing games.");
    return;
  }

  // Open game window
  const win = window.open("", "_blank");
  openGameWindows[gameId] = win;

  win.document.write(`<p>Loading ${gameId} from repo ${repo}...</p>`);

  // Pause immediately if launcher not focused or blocked
  if(!document.hasFocus() || userBlocked){
    win.document.body.innerHTML = "<p>Game paused. Please resume via launcher.</p>";
    win.isPaused = true;
  }

  // Simulate save/resume interval
  const interval = setInterval(()=>{
    if(win.closed){
      clearInterval(interval);
      delete openGameWindows[gameId];
      return;
    }
    if(win.isPaused) return;

    // Save game periodically (placeholder)
    // await saveGameData(gameId, win.savedData);
  }, 5000);
}

// --------------------
// Initialize Part 3
// --------------------
async function initPart3(){
  await enforceNameSignup();
  await checkUserBlocked();
}

initPart3();

</script>
<script type="module">
// --------------------
// Firebase Setup (Part 4)
// --------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

// Firebase config (replace with your own)
/*const firebaseConfig = {
  apiKey: "AIzaSyC9A9TbMSib5-_dW4A9w0jNySfN-0TkR48",
  authDomain: "mhi-v4.firebaseapp.com",
  projectId: "mhi-v4",
  storageBucket: "mhi-v4.firebasestorage.app",
  messagingSenderId: "592695127206",
  appId: "1:592695127206:web:c423586566d72084ff9867",
  measurementId: "G-YY300GTP5H"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
*/
// --------------------
// User References
// --------------------
const userRef = doc(db,"users", userCode);

// --------------------
// Load User Data from Firebase
// --------------------
let settings = { cookiesPerGame:3, darkMode:true };
let favorites = [];
let savedGames = {};

async function loadUserData(){
  const docSnap = await getDoc(userRef);
  if(docSnap.exists()){
    const data = docSnap.data();
    favorites = data.favorites || [];
    savedGames = data.savedGames || {};
    settings = data.settings || settings;
    userBlocked = data.blocked?.games || false;

    if(userBlocked){
      pauseAllGames();
      alert("You are blocked from playing games.");
    }
  } else {
    // First-time user: create document
    await setDoc(userRef,{
      fullName: userName,
      userCode,
      favorites: [],
      savedGames: {},
      settings,
      gamesPlayed: 0,
      blocked: { games:false, proxy:false },
      status: "active"
    });
  }
}

// --------------------
// Listen for real-time changes
// --------------------
onSnapshot(userRef, (docSnap)=>{
  if(!docSnap.exists()) return;
  const data = docSnap.data();

  favorites = data.favorites || favorites;
  savedGames = data.savedGames || savedGames;
  settings = data.settings || settings;

  const blockedNow = data.blocked?.games || false;
  if(blockedNow !== userBlocked){
    userBlocked = blockedNow;
    if(userBlocked){
      pauseAllGames();
      alert("You have been blocked from playing games!");
    } else {
      resumeAllGames();
    }
  }
});

// --------------------
// Save Favorites to Firebase
// --------------------
async function updateFavoritesFirebase(){
  await updateDoc(userRef,{favorites});
}

// --------------------
// Save Game to Firebase
// --------------------
async function saveGameFirebase(gameId, gameData){
  savedGames[gameId] = gameData;
  await updateDoc(userRef,{[`savedGames.${gameId}`]:gameData});
}

// --------------------
// Load Game Data
// --------------------
async function loadGameFirebase(gameId){
  return savedGames[gameId] || null;
}

// --------------------
// Status Tracking (active, sleeping, offline)
// --------------------
async function setUserStatus(status){
  await updateDoc(userRef,{status});
}

window.addEventListener("focus", ()=> setUserStatus("active"));
window.addEventListener("blur", ()=> setUserStatus("sleeping"));
window.addEventListener("beforeunload", ()=> setUserStatus("offline"));

// --------------------
// Override Launch Game with Firebase integration
// --------------------
window.launchGame = async function(repo, gameId){
  if(!userName || userName.length < 3){
    alert("Please enter your name first.");
    await enforceNameSignup();
    return;
  }
  if(userBlocked){
    alert("You are blocked from playing games.");
    return;
  }

  const savedData = await loadGameFirebase(gameId);
  const gameWin = window.open("", "_blank");
  openGameWindows[gameId] = gameWin;

  gameWin.savedData = savedData;
  gameWin.document.write(`<p>Loading ${gameId} from repo ${repo}...</p>`);

  if(!document.hasFocus() || userBlocked){
    gameWin.document.body.innerHTML = "<p>Game paused. Please resume via launcher.</p>";
    gameWin.isPaused = true;
  }

  const interval = setInterval(async ()=>{
    if(gameWin.closed){
      clearInterval(interval);
      delete openGameWindows[gameId];
      return;
    }
    if(gameWin.savedData){
      await saveGameFirebase(gameId, gameWin.savedData);
    }
  },5000);
}

// --------------------
// Initialize Part 4
// --------------------
async function initPart4(){
  await loadUserData();
  enforceNameSignup();
}
initPart4();

</script>
<script type="module">
// --------------------
// Built-in Activation Key
// --------------------


// --------------------
// Activation Screen Elements
// --------------------
const activationScreen = document.getElementById("activationScreen");
const activationInput = document.getElementById("activationInput");
const activationBtn = document.getElementById("activationBtn");
const activationError = document.getElementById("activationError");

// --------------------
// Validate Key
// --------------------
async function validateActivationKey(inputKey){
  try {
    const response = await fetch("/games5/activation_keys.txt");
    if(!response.ok) throw new Error("Cannot load activation keys.");
    const keysText = await response.text();
    const validKeys = keysText.split("\n").map(line=>line.trim());

    // Check built-in key matches file content
    if(validKeys.includes(inputKey) && inputKey === BUILT_IN_KEY){
      return true;
    } else {
      return false;
    }
  } catch(e){
    console.error("Activation key validation error:", e);
    return false;
  }
}

// --------------------
// Activation Button Click
// --------------------
activationBtn.addEventListener("click", async ()=>{
  const inputKey = activationInput.value.trim();
  const valid = await validateActivationKey(inputKey);

  if(valid){
    activationScreen.classList.add("hidden");
    nameScreen.classList.remove("hidden");
    // Resume any paused games
    resumeAllGames();
  } else {
    activationError.textContent = "Invalid activation key!";
    pauseAllGames();
  }
});

// --------------------
// Pause games until activation is valid
// --------------------
pauseAllGames();

// --------------------
// Initialize Part 5
// --------------------
async function initPart5(){
  // If user already stored key, validate immediately
  const storedKey = localStorage.getItem("activationKey");
  if(storedKey){
    const valid = await validateActivationKey(storedKey);
    if(valid){
      activationScreen.classList.add("hidden");
      nameScreen.classList.remove("hidden");
      resumeAllGames();
    }
  }
}
initPart5();

</script>
<script type="module">
// --------------------
// About Page Loader
// --------------------
async function loadAboutPage() {
  try {
    const response = await fetch("/games5/about.txt");
    if (!response.ok) throw new Error("Failed to fetch about.txt");
    const text = await response.text();

    // Split text into lines and process formatting
    const lines = text.split("\n");
    let html = "";

    lines.forEach(line => {
      if(line.startsWith("//")) return; // skip comments
      let processed = line
        .replace(/<center>/g, '<div style="text-align:center;">')
        .replace(/<\/center>/g, '</div>')
        .replace(/<bold>/g, '<b>').replace(/<\/bold>/g,'</b>')
        .replace(/<italics>/g,'<i>').replace(/<\/italics>/g,'</i>')
        .replace(/<small>/g,'<small>').replace(/<\/small>/g,'</small>')
        .replace(/<link-(.*?)>/g,'<a href="$1" target="_blank">here</a>')
        .replace(/<email>/g,'<a href="mailto:andercol046@alpinesd.org">here</a>');
      html += processed + "<br>";
    });

    gamesContainer.innerHTML = `<div style="width:80%; max-width:700px; margin:0 auto;">${html}</div>`;
  } catch(e){
    gamesContainer.innerHTML = "<p style='color:red;'>Error loading about.txt</p>";
    console.error(e);
  }
}

// --------------------
// Update renderGames to include About page
// --------------------
function renderGames(){
  gamesContainer.innerHTML = "";
  let displayGames = [];

  if(currentPage==="games") displayGames = allGames;
  else if(currentPage==="favorites") displayGames = allGames.filter(g=>favorites.includes(g.id));
  else if(currentPage==="about") {
    loadAboutPage();
    return;
  } else if(currentPage==="proxy") {
    renderProxyPage();
    return;
  }

  displayGames.forEach(game=>{
    const card = createGameCard(game);
    gamesContainer.appendChild(card);
  });
}

// --------------------
// Page Button Navigation
// --------------------
pageButtons.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    currentPage = btn.dataset.page;
    updatePagesUI();
    if(currentPage==="about"){
      loadAboutPage();
      searchInput.style.display="none";
    } else if(currentPage==="proxy"){
      renderProxyPage();
      searchInput.style.display="none";
    } else {
      renderGames();
      searchInput.style.display="block";
    }
  });
});

</script>
<script type="module">
// --------------------
// Proxy Page Renderer
// --------------------
function renderProxyPage(){
  gamesContainer.innerHTML = "";
  const proxyBtn = document.createElement("button");
  proxyBtn.textContent = "Launch Proxy";
  proxyBtn.style.padding = "20px";
  proxyBtn.style.fontSize = "18px";
  proxyBtn.addEventListener("click", ()=>{
    if(!navigator.onLine){
      alert("You are offline. Proxy cannot be launched.");
      return;
    }
    const proxyWindow = window.open("/prox.html", "_blank");
    openGameWindows["proxy"] = proxyWindow;
    monitorWindow(proxyWindow, "proxy");
  });
  gamesContainer.appendChild(proxyBtn);
}

// --------------------
// Random Game Button
// --------------------
const randomBtn = document.createElement("button");
randomBtn.textContent = "Random Game";
randomBtn.style.position = "fixed";
randomBtn.style.top = "10px";
randomBtn.style.right = "10px";
randomBtn.style.zIndex = "9999";
randomBtn.style.padding = "8px 12px";
randomBtn.style.fontSize = "14px";
document.body.appendChild(randomBtn);

randomBtn.addEventListener("click", ()=>{
  if(allGames.length===0) return;
  const randIndex = Math.floor(Math.random()*allGames.length);
  const game = allGames[randIndex];
  launchGame(game.repo, game.id);
});

// --------------------
// Pause/Resume Utility
// --------------------


function monitorWindow(win, key){
  const interval = setInterval(()=>{
    if(win.closed){
      clearInterval(interval);
      delete openGameWindows[key];
      return;
    }
    // Optionally implement save/auto-pause per game here
  }, 5000);
}

function pauseAllGames(){
  Object.values(openGameWindows).forEach(win=>{
    try {
      if(!win.closed) win.document.body.style.filter = "grayscale(80%)"; // visual cue paused
      if(!win.closed) win.savedData = win.savedData || {};
      if(!win.closed) win.savedData.paused = true;
    } catch(e){}
  });
}

function resumeAllGames(){
  Object.values(openGameWindows).forEach(win=>{
    try {
      if(!win.closed) win.document.body.style.filter = "";
      if(!win.closed && win.savedData) win.savedData.paused = false;
    } catch(e){}
  });
}

// --------------------
// Page Button Navigation (update for Proxy)
// --------------------
pageButtons.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    currentPage = btn.dataset.page;
    updatePagesUI();
    if(currentPage==="about"){
      loadAboutPage();
      searchInput.style.display="none";
    } else if(currentPage==="proxy"){
      renderProxyPage();
      searchInput.style.display="none";
    } else {
      renderGames();
      searchInput.style.display="block";
    }
  });
});

// --------------------
// Launcher Close Protection
// --------------------
window.addEventListener("beforeunload", (e)=>{
  // If any game windows are open, warn the user
  if(Object.keys(openGameWindows).length > 0){
    pauseAllGames();
    e.preventDefault();
    e.returnValue = "Closing the launcher will pause all games until it is reopened. Are you sure?";
  }
});

</script>
<script type="module">
/* =========================
   PART 8 â€“ CONTROL LAYER
   ========================= */

import {
  getDatabase,
  ref,
  onValue,
  set,
  serverTimestamp,
  onDisconnect
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ---- REQUIRED EXISTING VARS ----
   firebaseApp
   userUID
   openGameWindows
-------------------------------- */



let launcherLocked = false;

/* =========================
   ONLINE / OFFLINE PRESENCE
   ========================= */

if (navigator.onLine) {
  set(userRef, {
    online: true,
    lastSeen: serverTimestamp()
  });

  onDisconnect(userRef).update({
    online: false,
    lastSeen: serverTimestamp()
  });
}

/* =========================
   GAME PAUSE / RESUME
   ========================= */

function pauseAllGames() {
  Object.values(openGameWindows).forEach(win => {
    try {
      if (!win.closed) {
        win.document.body.innerHTML = `
          <div style="
            background:black;
            color:white;
            height:100vh;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:24px;">
            GAME PAUSED
          </div>`;
      }
    } catch {}
  });
}

function resumeAllGames() {
  Object.values(openGameWindows).forEach(win => {
    try {
      if (!win.closed) {
        win.location.reload();
      }
    } catch {}
  });
}

/* =========================
   LOCK SCREEN
   ========================= */

function lockLauncher(reason) {
  if (launcherLocked) return;
  launcherLocked = true;

  pauseAllGames();

  const overlay = document.createElement("div");
  overlay.id = "launcherLock";
  overlay.innerHTML = `
    <h2>${reason}</h2>
    <input id="nameInput" placeholder="Enter name" />
    <button id="saveName">Save</button>
  `;

  Object.assign(overlay.style, {
    position: "fixed",
    inset: "0",
    background: "#000",
    color: "#fff",
    display: "flex",
    flexDirection: "column",
    alignItems: "center",
    justifyContent: "center",
    zIndex: "99999"
  });

  document.body.appendChild(overlay);

  document.getElementById("saveName").onclick = () => {
    const name = document.getElementById("nameInput").value.trim();
    if (name.length < 3) return alert("Name too short");

    set(ref(db, `users/${userUID}/name`), name);
    unlockLauncher();
  };
}

function unlockLauncher() {
  launcherLocked = false;
  document.getElementById("launcherLock")?.remove();
  resumeAllGames();
}

/* =========================
   FIREBASE CONTROL CHECK
   ========================= */

onValue(userRef, snap => {
  if (!snap.exists()) return;
  const data = snap.val();

  /* OFFLINE = FREE PLAY */
  if (!navigator.onLine) {
    unlockLauncher();
    return;
  }

  /* BLOCKED */
  if (data.blocked === true) {
    lockLauncher("You are blocked.");
    return;
  }

  /* NAME REQUIRED */
  if (!data.name) {
    lockLauncher("You must set a name to continue.");
    return;
  }

  unlockLauncher();
});

/* =========================
   ABOUT.TXT LOADER
   ========================= */

window.loadAboutPage = async function () {
  gamesContainer.innerHTML = "Loading...";
  try {
    const res = await fetch("./games/about.txt");
    const text = await res.text();
    gamesContainer.innerHTML = `<pre>${text}</pre>`;
  } catch {
    gamesContainer.innerHTML = "Failed to load about.txt";
  }
};

/* =========================
   LAUNCHER CLOSE HANDLING
   ========================= */

window.addEventListener("beforeunload", () => {
  if (navigator.onLine) {
    pauseAllGames();
  }
});
</script>
<script type="module">
/* =========================
   PART 9 â€“ ADMIN CONTROL
   ========================= */

import {
  ref,
  onValue,
  update
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* REQUIRED EXISTING VARS:
   db
   userUID
*/

let isAdmin = false;

/* =========================
   ADMIN FLAG
   ========================= */

onValue(ref(db, `users/${userUID}/admin`), snap => {
  isAdmin = snap.val() === true;
  if (isAdmin) showAdminPanel();
});

/* =========================
   ADMIN PANEL
   ========================= */

function showAdminPanel() {
  if (document.getElementById("adminPanel")) return;

  const panel = document.createElement("div");
  panel.id = "adminPanel";

  panel.innerHTML = `
    <h3>Admin Panel</h3>
    <div id="adminUserList"></div>
  `;

  Object.assign(panel.style, {
    position: "fixed",
    right: "10px",
    bottom: "10px",
    width: "280px",
    maxHeight: "400px",
    overflow: "auto",
    background: "#111",
    color: "#fff",
    padding: "10px",
    zIndex: "99999"
  });

  document.body.appendChild(panel);
  watchUsers();
}

/* =========================
   USER LIST + CONTROLS
   ========================= */

function watchUsers() {
  const list = document.getElementById("adminUserList");

  onValue(ref(db, "users"), snap => {
    list.innerHTML = "";

    snap.forEach(userSnap => {
      const uid = userSnap.key;
      const u = userSnap.val();

      const row = document.createElement("div");
      row.style.borderBottom = "1px solid #333";
      row.style.marginBottom = "6px";

      row.innerHTML = `
        <b>${u.name || "(no name)"}</b>
        <div>Status: ${u.online ? "ðŸŸ¢" : "ðŸ”´"}</div>
        <button data-act="block">${u.blocked ? "Unblock" : "Block"}</button>
        <button data-act="rename">Force Rename</button>
      `;

      row.querySelector("[data-act='block']").onclick = () => {
        update(ref(db, `users/${uid}`), {
          blocked: !u.blocked
        });
      };

      row.querySelector("[data-act='rename']").onclick = () => {
        update(ref(db, `users/${uid}`), {
          name: null
        });
      };

      list.appendChild(row);
    });
  });
}
</script>
